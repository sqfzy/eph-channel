#set document(title: "foo", author: "sqfzy", date: datetime(
  year: 2026,
  month: 2,
  day: 6,
  hour: 11,
  minute: 19,
  second: 56,
))

#import "@local/common:0.0.1": *
#show: common.with()

= 原 RingBuffer 的竟态在哪

pop_latest() 得到指针后，指针指向的内存马上被视为空闲，没有任何保护。此时，若 reader 对指针指向的内存做耗时操作（例如解析），那么 writer 只要足够快地绕圈，就可能
与 reader 发生竟态。

- 读到撕裂的变量：在竟态内存中，如果 reader 读取的变量跨越了缓存行，那么 reader 需要访问两次内存，第一次访问到的是数据的前半部分，第二次访问到的是数据的后半部分。
  如果 writer 在 reader 访问两次内存之间修改了这个数据，那么 reader 就可能读到撕裂的数据。

- 可见性：由于竟态内存数据没有任何同步机制，所以即便 writer 已经绕圈覆盖了内存中的某个变量，writer 可能只是更新了它自己的寄存器、L1/L2 缓存，它不会有意识地告诉 reader 数据已经被覆盖了。
  reader 原本应该读到最新数据，但它只能看到旧数据。

- 读到撕裂的数据包：reader 解析到一半时，writer 把数据包覆盖了，于是 reader 解析到的另一半与前一半是不一致的。因此 reader 解析时，必须锁数据包或使用其它同步方式。

== 验证
放缓 writer（每次停 1s）后，没有检测到 `head_canary != tail_canary`

== Average Age at Discard (AAoD) 指标
把所有生成的包（包括那些被丢弃或跳过的包）从生成到“最近一次读取”的时间差取平均，从而衡量系统中所有数据尝试的“平均存活时延”。

= Buffer size 是 U 型收益
== 为什么？
| Buffer Size | 竞争 (Contention) | 缓存命中率 (Cache Hit) | AAOD | 主要瓶颈 |
| --- | --- | --- | --- | --- |
| *Small (1-4)* | *极高 (High)* | 高 (High) | *差* | Reader 陷入重试死循环 (Starvation by overwrite) |
| *Medium (8-64)* | 低 (Low) | *高 (High)* | *优* | 达到平衡：无重试且全在 L1/L2 Cache 中 |
| *Large (4k+)* | 无 (None) | *低 (Low)* | *一般* | Cache/TLB Miss 增加，内存延迟占主导 |

Small 可能更容易抖动。


#note_todo("U-shaped image")

= Data size 呢

= push 速度?
push 速度太快会导致 aaod 有很大的抖动。

= 优化技术


== all

== baseline
+--------------------+-----------+-----------+-----------+-----------+-----------+-----------+
| DataSize \ BufSize |    2 B    |    8 B    |    32 B   |    64 B   |   512 B   |   4096 B  |
+--------------------+-----------+-----------+-----------+-----------+-----------+-----------+
| 64 B               | 373.39 ns | 341.21 ns | 351.47 ns | 339.01 ns | 363.18 ns | 397.62 ns |
+--------------------+-----------+-----------+-----------+-----------+-----------+-----------+
| 256 B              | 489.58 ns | 419.05 ns | 458.09 ns | 461.68 ns | 472.02 ns | 531.43 ns |
+--------------------+-----------+-----------+-----------+-----------+-----------+-----------+
| 1024 B             | 700.76 ns | 568.86 ns | 606.78 ns | 553.31 ns | 596.08 ns | 623.13 ns |
+--------------------+-----------+-----------+-----------+-----------+-----------+-----------+

+--------------------+-----------+
| DataSize \ BufSize |    64 B   |
+--------------------+-----------+
| 128 B              | 247.07 ns |
+--------------------+-----------+

== cache line
+--------------------+-----------+-----------+-----------+-----------+-----------+-----------+
| DataSize \ BufSize |    2 B    |    8 B    |    32 B   |    64 B   |   512 B   |   4096 B  |
+--------------------+-----------+-----------+-----------+-----------+-----------+-----------+
| 64 B               | 376.77 ns | 341.30 ns | 349.41 ns | 345.57 ns | 368.84 ns | 411.35 ns |
+--------------------+-----------+-----------+-----------+-----------+-----------+-----------+
| 256 B              | 499.48 ns | 418.65 ns | 455.48 ns | 471.99 ns | 480.47 ns | 535.08 ns |
+--------------------+-----------+-----------+-----------+-----------+-----------+-----------+
| 1024 B             | 679.18 ns | 597.34 ns | 563.11 ns | 533.94 ns | 593.24 ns | 588.54 ns |
+--------------------+-----------+-----------+-----------+-----------+-----------+-----------+

== 取模索引
+--------------------+------------+------------+------------+------------+------------+------------+
| DataSize \ BufSize |     2 B    |     8 B    |    32 B    |    64 B    |    512 B   |   4096 B   |
+--------------------+------------+------------+------------+------------+------------+------------+
| 64 B               | 420.49 ns  | 655.02 ns  | 659.01 ns  | 642.27 ns  | 725.00 ns  | 962.64 ns  |
+--------------------+------------+------------+------------+------------+------------+------------+
| 256 B              | 908.97 ns  | 817.33 ns  | 843.79 ns  | 940.58 ns  | 964.93 ns  | 1022.46 ns |
+--------------------+------------+------------+------------+------------+------------+------------+
| 1024 B             | 1041.56 ns | 1089.57 ns | 1076.37 ns | 1112.62 ns | 1219.62 ns | 1183.13 ns |
+--------------------+------------+------------+------------+------------+------------+------------+

== Shadow index
+--------------------+------------+------------+------------+-----------+------------+-----------+
| DataSize \ BufSize |     2 B    |     8 B    |    32 B    |    64 B   |    512 B   |   4096 B  |
+--------------------+------------+------------+------------+-----------+------------+-----------+
| 64 B               | 686.93 ns  | 665.27 ns  | 617.40 ns  | 713.17 ns | 865.94 ns  | 831.73 ns |
+--------------------+------------+------------+------------+-----------+------------+-----------+
| 256 B              | 795.66 ns  | 698.02 ns  | 908.44 ns  | 902.90 ns | 1054.12 ns | 954.42 ns |
+--------------------+------------+------------+------------+-----------+------------+-----------+
| 1024 B             | 1120.83 ns | 1119.08 ns | 1093.69 ns | 942.61 ns | 1009.34 ns | 540.41 ns |
+--------------------+------------+------------+------------+-----------+------------+-----------+

== Single SeqLock


== Triple buffer

= 注意
- 绑定NUMA与CPU核心
- 伪共享
- 大小核
